# Overview

This repo contains code to replicate an SSL issue using Simba JDBC driver and Workload Identity Federation with Github.

# Details

The genesis of the problem is from running migration scripts using [Flyway](https://flywaydb.org/) with Simba JDBC driver within Github Actions.

1. Github/Google Cloud is setup as per https://github.com/google-github-actions/auth#indirect-wif
2. The following Github workflow is used (not needed to replicate behavior, just for context)
```yml
name: Another day in dev

on:
  # push:
  #  branches: [ main ]
  pull_request:
    # branches:
    #  - 'release/*'

permissions:
  id-token: write
  contents: read

jobs:
  simba-driver-wif-job:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          token_format: "access_token"
          create_credentials_file: true
          workload_identity_provider: ${{ secrets.WORKLOAD_ID_PROVIDER_NAME }}
          service_account: ${{ secrets.WORKLOAD_ID_SA_EMAIL }}
      - name: Run db info
        run: env GOOGLE_APPLICATION_CREDENTIALS=${{steps.auth.outputs.credentials_file_path}} run_code_with_simba_driver.sh

```
3. The credentials/configuration generated by `google-github-actions/auth@v2` are similar to [test_creds.json](./test_creds.json) file.
4. The Simba JDBC Driver/Google API will try to authenticate using the `credential_source.url` specified in that configuration, specifically using a `*.actions.githubusercontent.com` domain.
5. When resolving SSL certifcates, a **(CERTIFICATE_UNKNOWN): PKIX path building failed** is thrown.


We can replicate this behavior with the files from this repository without using Github Actions:
1. [SSLTest.java](./SSLTest.java) contains the code using Simba JDBC DataSource class and a connection url as per [documentation](https://documentation.insightsoftware.com/simba-google-bigquery-jdbc-connector/content/jdbc/bq/authenticating/appdefaultcred.htm).
2. Credentials similar to those generated by `google-github-actions/auth@v2` are provided in [test_creds.json](./test_creds.json).

# Replication

Download Simba JDBC driver:
```bash
bash setup.sh
```

Compile and run code:
```bash
bash run.sh
```

The following error is thrown (extract for brevity):
```
(...)
Caused by: sun.security.validator.ValidatorException: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
        at java.base/sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:439)
        at java.base/sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:306)
        at java.base/sun.security.validator.Validator.validate(Validator.java:264)
        at java.base/sun.security.ssl.X509TrustManagerImpl.validate(X509TrustManagerImpl.java:313)
        at java.base/sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:222)
        at java.base/sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:129)
        at java.base/sun.security.ssl.CertificateMessage$T12CertificateConsumer.checkServerCerts(CertificateMessage.java:638)
        ... 48 more
Caused by: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target
        at java.base/sun.security.provider.certpath.SunCertPathBuilder.build(SunCertPathBuilder.java:148)
        at java.base/sun.security.provider.certpath.SunCertPathBuilder.engineBuild(SunCertPathBuilder.java:129)
        at java.base/java.security.cert.CertPathBuilder.build(CertPathBuilder.java:297)
        at java.base/sun.security.validator.PKIXValidator.doBuild(PKIXValidator.java:434)
        ... 54 more
```

# Comparison

A separate test was added in [SSLTest.java](SSLTest.java) to compare URL connection and JDBC driver connection.
Called *check1* it's run before the code replicating the PKIX issue.

# Logs

To get more logs, uncomment and edit as needed the following line in [entry.sh](./mount/entry.sh):
```bash
#JAVA_ARGS+=(-Djavax.net.debug=ssl -Djava.security.debug=certpath)
```

Run the code again to get those logs:
```bash
bash run.sh
```
